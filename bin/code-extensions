#!/bin/bash

# This script is meant to keep VS Code's extensions in your dotfiles repo
# * To start using it, run `code-extensions snapshot`
# * To see how to bring your extensions up-to-date, run `code-extensions sync`
# * To set the current list of extensions as official, `code-extensions snapshot`


extensions() {
  # remove version numbers because it generates too much noise, also blank lines
  code --list-extensions
}

diff_list() {
  diff -u ~/.vscode/extensions.list <(extensions)
}

if [ "$1" == 'snapshot' ]; then
  extensions > ~/.vscode/extensions.list
  exit 0
fi

if [ ! -f ~/.vscode/extensions.list ]; then
  echo "please set things up by running:"
  echo "  $0 snapshot"
  exit 1
fi

case "$1" in
  # 'snapshot' is handled above

  'sync' | 'install')
    to_install="$(diff_list | sed -n 's/^-\([^-].*\)/\1/p')"
    if [ -n "$to_install" ]; then
      echo code --install-extension $to_install
    fi
    to_remove="$(diff_list | sed -n 's/^\+\([^+].*\)/\1/p')"
    if [ -n "$to_remove" ]; then
      echo code --uninstall-extension $to_remove
    fi
    if [ -z "$to_install" ] && [ -z "$to_remove" ]; then
      echo up to date
    fi
    ;;

  'show' | *)
    diff_list
    ;;
esac
