#!/bin/bash

# This script is meant to keep VS Code's extensions in your dotfiles repo
# * To start using it, run `code-extensions snapshot`
# * To see how to bring your extensions up-to-date, run `code-extensions sync`
# * To set the current list of extensions as official, `code-extensions snapshot`

# Hope this script doesn't have a future: https://code.visualstudio.com/updates/v1_43#_settings-sync


extensions() {
  # remove version numbers because it generates too much noise, also blank lines
  code --list-extensions
}

diff_list() {
  diff -u ~/.vscode/extensions.list <(extensions)
}

if [ ! -f ~/.vscode/extensions.list ] && [ "$1" != 'snapshot' ]; then
  echo "please set things up by running:"
  echo "  $0 snapshot"
  exit 1
fi

case "$1" in
  'snapshot')
    extensions > ~/.vscode/extensions.list
    ;;

  'sync' | 'install' | 'uninstall')
    to_install="$(diff_list | sed -n 's/^-\([^-].*\)/\1/p')"
    if [ -n "$to_install" ] && [ "$1" != 'uninstall' ]; then
      for extension in $to_install; do
        echo code --install-extension $extension
      done
    fi
    to_remove="$(diff_list | sed -n 's/^\+\([^+].*\)/\1/p')"
    if [ -n "$to_remove" ] && [ "$1" != 'install' ]; then
      for extension in $to_remove; do
        echo code --uninstall-extension $extension
      done
    fi
    if [ -z "$to_install" ] && [ -z "$to_remove" ]; then
      echo up to date
    fi
    ;;

  'show' | *)
    diff_list
    ;;
esac
